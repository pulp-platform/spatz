// Copyright 2021 ETH Zurich and University of Bologna.
// Solderpad Hardware License, Version 0.51, see LICENSE for details.
// SPDX-License-Identifier: SHL-0.51

// AUTOMATICALLY GENERATED by clustergen.py; edit the script or configuration
// instead.




`include "axi/typedef.svh"

// verilog_lint: waive-start package-filename
package spatz_cluster_pkg;

  ///////////
  //  AXI  //
  ///////////

  // AXI Data Width
  localparam int unsigned SpatzAxiDataWidth = 512;
  localparam int unsigned SpatzAxiStrbWidth = SpatzAxiDataWidth / 8;
  // AXI Address Width
  localparam int unsigned SpatzAxiAddrWidth = 32;
  // AXI ID Width
  localparam int unsigned SpatzAxiIdInWidth = 2;
  localparam int unsigned SpatzAxiIdOutWidth = 4;

  // AXI User Width
  localparam int unsigned SpatzAxiUserWidth = 2;

  typedef logic [SpatzAxiDataWidth-1:0] axi_data_t;
  typedef logic [SpatzAxiStrbWidth-1:0] axi_strb_t;
  typedef logic [SpatzAxiAddrWidth-1:0] axi_addr_t;
  typedef logic [SpatzAxiIdInWidth-1:0] axi_id_in_t;
  typedef logic [SpatzAxiIdOutWidth-1:0] axi_id_out_t;
  typedef logic [SpatzAxiUserWidth-1:0] axi_user_t;


  `AXI_TYPEDEF_ALL(spatz_axi_in, axi_addr_t, axi_id_in_t, logic [63:0], logic [7:0], axi_user_t)
  `AXI_TYPEDEF_ALL(spatz_axi_out, axi_addr_t, axi_id_out_t, axi_data_t, axi_strb_t, axi_user_t)

  ////////////////////
  //  Spatz Cluster //
  ////////////////////

  localparam int unsigned NumCores = 2;

  localparam int unsigned DataWidth  = 64;
  localparam int unsigned BeWidth    = DataWidth / 8;
  localparam int unsigned ByteOffset = $clog2(BeWidth);

  localparam int unsigned ICacheLineWidth = 256;
  localparam int unsigned ICacheLineCount = 64;
  localparam int unsigned ICacheWays = 2;

  localparam int unsigned TCDMStartAddr = 32'h100000;
  localparam int unsigned TCDMSize      = 32'h20000;

  localparam int unsigned PeriStartAddr = TCDMStartAddr + TCDMSize;

  localparam int unsigned BootAddr      = 32'h1000;

  function automatic snitch_pma_pkg::rule_t [snitch_pma_pkg::NrMaxRules-1:0] get_cached_regions();
    automatic snitch_pma_pkg::rule_t [snitch_pma_pkg::NrMaxRules-1:0] cached_regions;
    cached_regions = '{default: '0};
    cached_regions[0] = '{base: 32'h80000000, mask: 32'h80000000};
    return cached_regions;
  endfunction

  localparam snitch_pma_pkg::snitch_pma_t SnitchPMACfg = '{
      NrCachedRegionRules: 1,
      CachedRegion: get_cached_regions(),
      default: 0
  };

  localparam fpnew_pkg::fpu_implementation_t FPUImplementation [NumCores] = '{
    '{
        PipeRegs: // FMA Block
                  '{
                    '{  1, // FP32
                        2, // FP64
                        0, // FP16
                        0, // FP8
                        0, // FP16alt
                        0  // FP8alt
                      },
                    '{1, 1, 1, 1, 1, 1},   // DIVSQRT
                    '{1,
                      1,
                      1,
                      1,
                      1,
                      1},   // NONCOMP
                    '{2,
                      2,
                      2,
                      2,
                      2,
                      2},   // CONV
                    '{2,
                      2,
                      2,
                      2,
                      2,
                      2}    // DOTP
                    },
        UnitTypes: '{'{fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED},  // FMA
                    '{fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED}, // DIVSQRT
                    '{fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL}, // NONCOMP
                    '{fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED},   // CONV
                    '{fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED}},  // DOTP
        PipeConfig: fpnew_pkg::BEFORE
    },
    '{
        PipeRegs: // FMA Block
                  '{
                    '{  1, // FP32
                        2, // FP64
                        0, // FP16
                        0, // FP8
                        0, // FP16alt
                        0  // FP8alt
                      },
                    '{1, 1, 1, 1, 1, 1},   // DIVSQRT
                    '{1,
                      1,
                      1,
                      1,
                      1,
                      1},   // NONCOMP
                    '{2,
                      2,
                      2,
                      2,
                      2,
                      2},   // CONV
                    '{2,
                      2,
                      2,
                      2,
                      2,
                      2}    // DOTP
                    },
        UnitTypes: '{'{fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED,
                       fpnew_pkg::MERGED},  // FMA
                    '{fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED,
                        fpnew_pkg::DISABLED}, // DIVSQRT
                    '{fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL,
                        fpnew_pkg::PARALLEL}, // NONCOMP
                    '{fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED},   // CONV
                    '{fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED,
                        fpnew_pkg::MERGED}},  // DOTP
        PipeConfig: fpnew_pkg::BEFORE
    }
  };

endpackage
// verilog_lint: waive-stop package-filename

module spatz_cluster_wrapper
 import spatz_cluster_pkg::*;
 import fpnew_pkg::fpu_implementation_t;
 import snitch_pma_pkg::snitch_pma_t;
 #(
  parameter int unsigned AxiAddrWidth  = spatz_cluster_pkg::SpatzAxiAddrWidth,
  parameter int unsigned AxiDataWidth  = spatz_cluster_pkg::SpatzAxiDataWidth,
  parameter int unsigned AxiUserWidth  = spatz_cluster_pkg::SpatzAxiUserWidth,
  parameter int unsigned AxiInIdWidth  = spatz_cluster_pkg::SpatzAxiIdInWidth,
  parameter int unsigned AxiOutIdWidth = spatz_cluster_pkg::SpatzAxiIdOutWidth,
  parameter int unsigned IwcAxiIdOutWidth = 3,

  parameter type axi_in_resp_t = spatz_axi_in_resp_t,
  parameter type axi_in_req_t  = spatz_axi_in_req_t,

  parameter type axi_out_resp_t = spatz_axi_out_resp_t,
  parameter type axi_out_req_t  = spatz_axi_out_req_t
)(
  input  logic                clk_i,
  input  logic                rst_ni,
  input  logic [NumCores-1:0] debug_req_i,

  input  logic [NumCores-1:0] meip_i,
  input  logic [NumCores-1:0] mtip_i,
  input  logic [NumCores-1:0] msip_i,
  output logic                          cluster_probe_o,
  input  axi_in_req_t   axi_in_req_i,
  output axi_in_resp_t  axi_in_resp_o,
  output axi_out_req_t  axi_out_req_o,
  input  axi_out_resp_t axi_out_resp_i
);

  localparam int unsigned NumIntOutstandingLoads   [NumCores] = '{1, 1};
  localparam int unsigned NumIntOutstandingMem     [NumCores] = '{4, 4};
  localparam int unsigned NumSpatzOutstandingLoads [NumCores] = '{4, 4};
  localparam int unsigned NumSpatzFPUs             [NumCores] = '{default: 4};
  localparam int unsigned NumSpatzIPUs             [NumCores] = '{default: 1};

  typedef logic [IwcAxiIdOutWidth-1:0] axi_id_out_iwc_t;

  `AXI_TYPEDEF_ALL(spatz_axi_iwc_out, axi_addr_t, axi_id_out_iwc_t, axi_data_t, axi_strb_t, axi_user_t)

  spatz_axi_iwc_out_req_t axi_from_cluster_iwc_req;
  spatz_axi_iwc_out_resp_t axi_from_cluster_iwc_resp;




  axi_iw_converter #(
    .AxiSlvPortIdWidth ( IwcAxiIdOutWidth ),
    .AxiMstPortIdWidth ( AxiOutIdWidth ),
    .AxiSlvPortMaxUniqIds ( 2 ),
    .AxiSlvPortMaxTxnsPerId (2),
    .AxiSlvPortMaxTxns (4),
    .AxiMstPortMaxUniqIds (2),
    .AxiMstPortMaxTxnsPerId (4),
    .AxiAddrWidth ( AxiAddrWidth ),
    .AxiDataWidth ( AxiDataWidth ),
    .AxiUserWidth ( AxiUserWidth ),
    .slv_req_t  (spatz_axi_iwc_out_req_t),
    .slv_resp_t (spatz_axi_iwc_out_resp_t),
    .mst_req_t  ( axi_out_req_t),
    .mst_resp_t ( axi_out_resp_t)
  ) iw_converter(
    .clk_i      ( clk_i  ),
    .rst_ni     ( rst_ni ),
    .slv_req_i  ( axi_from_cluster_iwc_req  ),
    .slv_resp_o ( axi_from_cluster_iwc_resp ),
    .mst_req_o  ( axi_out_req_o  ),
    .mst_resp_i ( axi_out_resp_i )
   );

  // Spatz cluster under test.
  spatz_cluster #(
    .AxiAddrWidth (AxiAddrWidth),
    .AxiDataWidth (AxiDataWidth),
    .AxiIdWidthIn (AxiInIdWidth),
    .AxiIdWidthOut (IwcAxiIdOutWidth),
    .AxiUserWidth (AxiUserWidth),
    .BootAddr (32'h1000),
    .ClusterPeriphSize (64),
    .NrCores (2),
    .TCDMDepth (1024),
    .NrBanks (16),
    .ICacheLineWidth (spatz_cluster_pkg::ICacheLineWidth),
    .ICacheLineCount (spatz_cluster_pkg::ICacheLineCount),
    .ICacheWays (spatz_cluster_pkg::ICacheWays),
    .FPUImplementation (spatz_cluster_pkg::FPUImplementation),
    .SnitchPMACfg (spatz_cluster_pkg::SnitchPMACfg),
    .NumIntOutstandingLoads (NumIntOutstandingLoads),
    .NumIntOutstandingMem (NumIntOutstandingMem),
    .NumSpatzOutstandingLoads (NumSpatzOutstandingLoads),
    .NumSpatzFPUs (NumSpatzFPUs),
    .NumSpatzIPUs (NumSpatzIPUs),
    .axi_in_req_t (axi_in_req_t),
    .axi_in_resp_t (axi_in_resp_t),
    .axi_out_req_t (spatz_axi_iwc_out_req_t),
    .axi_out_resp_t (spatz_axi_iwc_out_resp_t),
    .Xdma (2'b01),
    .DMAAxiReqFifoDepth (3),
    .DMAReqFifoDepth (3),
    .RegisterOffloadRsp (1),
    .RegisterCoreReq (1),
    .RegisterCoreRsp (1),
    .RegisterTCDMCuts (0),
    .RegisterExt (0),
    .XbarLatency (axi_pkg::CUT_ALL_PORTS),
    .MaxMstTrans (4),
    .MaxSlvTrans (4)
  ) i_cluster (
    .clk_i,
    .rst_ni,
    .debug_req_i,
    .meip_i,
    .mtip_i,
    .msip_i,
    .hart_base_id_i (10'h0),
    .cluster_base_addr_i (32'h100000),
    .axi_core_default_user_i (2'h1),
    .cluster_probe_o,
    .axi_in_req_i,
    .axi_in_resp_o,
    // AXI Master Port
    .axi_out_req_o  ( axi_from_cluster_iwc_req ),
    .axi_out_resp_i ( axi_from_cluster_iwc_resp )
  );

endmodule
