// Copyright 2021 ETH Zurich and University of Bologna.
// Solderpad Hardware License, Version 0.51, see LICENSE for details.
// SPDX-License-Identifier: SHL-0.51
//
// Author: Matteo Perotti <mperotti@iis.ee.ethz.ch>
//         Basile Bougenot <bbougenot@student.ethz.ch>

#include "float_macros.h"
#include "vector_macros.h"

// Simple random test with similar values + 1 subnormal
void TEST_CASE1(void) {
  VSET(16, e16, m2);
  //              -0.6377, -0.2332,  0.9458, -0.2612, -0.6772,  0.4543,  0.1002,
  //              0.7764,  0.7979, -0.8599,  0.7837, -0.2461,  0.4221,  0.2251,
  //              0.7739,  0.1461
  VLOAD_16(v4, 0xb91a, 0xb376, 0x3b91, 0xb42e, 0xb96b, 0x3745, 0x2e69, 0x3a36,
           0x3a62, 0xbae1, 0x3a45, 0xb3e0, 0x36c1, 0x3334, 0x3a31, 0x30ad);
  //               0.9551, -0.6787,  0.5605, -0.7305, -0.7197, -0.1581,  0.7271,
  //               0.6113,  0.2971, -0.8062,  0.9668, -0.5278,  0.3972, -0.1084,
  //               -0.3015,  0.9556
  VLOAD_16(v6, 0x3ba4, 0xb96e, 0x387c, 0xb9d8, 0xb9c2, 0xb10f, 0x39d1, 0x38e4,
           0x34c1, 0xba73, 0x3bbc, 0xb839, 0x365b, 0xaef0, 0xb4d3, 0x3ba5);
  //               0.7402,  0.0935,  0.1455, -0.2771,  0.3347,  0.7964,  0.6543,
  //               -0.7534,  0.2476,  0.0338,  0.9980,  0.3284,  0.2239,
  //               -0.4551,  0.6694, -0.8550
  VLOAD_16(v2, 0x39ec, 0x2dfc, 0x30a8, 0xb46f, 0x355b, 0x3a5f, 0x393c, 0xba07,
           0x33ec, 0x2853, 0x3bfc, 0x3541, 0x332a, 0xb748, 0x395b, 0xbad7);
  asm volatile("vfnmacc.vv v2, v4, v6");
  //              -0.1313, -0.2517, -0.6758,  0.0863, -0.8223, -0.7246, -0.7271,
  //              0.2788, -0.4846, -0.7271, -1.7559, -0.4583, -0.3916,  0.4795,
  //              -0.4360,  0.7153
  VCMP_U16(1, v2, 0xb033, 0xb407, 0xb968, 0x2d86, 0xba94, 0xb9cc, 0xb9d1,
           0x3476, 0xb7c1, 0xb9d1, 0xbf06, 0xb755, 0xb644, 0x37ac, 0xb6fa,
           0x39b9);

  VSET(16, e32, m2);
  //              -0.17374928, -0.36242354, -0.18093164,  0.94970566,
  //              -0.45790458, -0.17780401, -0.51985794, -0.04832974,
  //              0.13252106,  0.77533042,  0.42536697, -0.72199643,
  //              -0.25088808,  0.28798762,  0.66300607, -0.63549894
  VLOAD_32(v4, 0xbe31eb55, 0xbeb98f94, 0xbe394625, 0x3f731fe9, 0xbeea7278,
           0xbe361241, 0xbf051569, 0xbd45f569, 0x3e07b39a, 0x3f467c0e,
           0x3ed9c9b3, 0xbf38d4c2, 0xbe807467, 0x3e93731d, 0x3f29bac4,
           0xbf22b00f);
  //              -0.61242568,  0.71439523, -0.15632962,  0.10917858,
  //              0.19637996, -0.88467985,  0.73412597, -0.98048240, 0.25438991,
  //              -0.02058743, -0.00876777,  0.21936898, -0.71130067,
  //              -0.29675287, -0.96093589,  0.24695934
  VLOAD_32(v6, 0xbf1cc7ee, 0x3f36e29b, 0xbe2014df, 0x3ddf9905, 0x3e4917d4,
           0xbf627a61, 0x3f3befae, 0xbf7b00e5, 0x3e823f65, 0xbca8a6f9,
           0xbc0fa6af, 0x3e60a243, 0xbf3617cd, 0xbe97effe, 0xbf75ffe5,
           0x3e7ce2e9);
  //               0.77600455,  0.02542816, -0.63618338,  0.11704731,
  //               0.45613721, -0.90825689,  0.21235447,  0.35766414,
  //               0.08650716, -0.98431164,  0.21029140, -0.92919809,
  //               0.46440944,  0.70648551, -0.80876821, -0.19595607
  VLOAD_32(v2, 0x3f46a83c, 0x3cd04eb8, 0xbf22dcea, 0x3defb680, 0x3ee98ad1,
           0xbf688386, 0x3e597373, 0x3eb71fc1, 0x3db12aaa, 0xbf7bfbd9,
           0x3e5756a1, 0xbf6ddfed, 0x3eedc713, 0x3f34dc3c, 0xbf4f0b6f,
           0xbe48a8b5);
  asm volatile("vfnmacc.vv v2, v4, v6");
  //              -0.88241309,  0.23348548,  0.60789841, -0.22073483,
  //              -0.36621392,  0.75095725,  0.16928674, -0.40505061,
  //              -0.12021918,  1.00027370, -0.20656188,  1.08758175,
  //              -0.64286631, -0.62102437,  1.44587445,  0.35289848
  VCMP_U32(2, v2, 0xbf61e5d3, 0x3e6f16d2, 0x3f1b9f3b, 0xbe62084f, 0xbebb8064,
           0x3f403ebc, 0x3e2d5982, 0xbecf62cb, 0xbdf63579, 0x3f8008f8,
           0xbe5384f5, 0x3f8b35e1, 0xbf2492e3, 0xbf1efb74, 0x3fb9126b,
           0x3eb4af1c);
};

// Simple random test with similar values + 1 subnormal (masked)
// The numbers are the same of TEST_CASE1
void TEST_CASE2(void) {
  VSET(16, e16, m2);
  //              -0.6377, -0.2332,  0.9458, -0.2612, -0.6772,  0.4543,  0.1002,
  //              0.7764,  0.7979, -0.8599,  0.7837, -0.2461,  0.4221,  0.2251,
  //              0.7739,  0.1461
  VLOAD_16(v4, 0xb91a, 0xb376, 0x3b91, 0xb42e, 0xb96b, 0x3745, 0x2e69, 0x3a36,
           0x3a62, 0xbae1, 0x3a45, 0xb3e0, 0x36c1, 0x3334, 0x3a31, 0x30ad);
  //               0.9551, -0.6787,  0.5605, -0.7305, -0.7197, -0.1581,  0.7271,
  //               0.6113,  0.2971, -0.8062,  0.9668, -0.5278,  0.3972, -0.1084,
  //               -0.3015,  0.9556
  VLOAD_16(v6, 0x3ba4, 0xb96e, 0x387c, 0xb9d8, 0xb9c2, 0xb10f, 0x39d1, 0x38e4,
           0x34c1, 0xba73, 0x3bbc, 0xb839, 0x365b, 0xaef0, 0xb4d3, 0x3ba5);
  VLOAD_8(v0, 0xAA, 0xAA);
  //               0.7402,  0.0935,  0.1455, -0.2771,  0.3347,  0.7964,  0.6543,
  //               -0.7534,  0.2476,  0.0338,  0.9980,  0.3284,  0.2239,
  //               -0.4551,  0.6694, -0.8550
  VLOAD_16(v2, 0x39ec, 0x2dfc, 0x30a8, 0xb46f, 0x355b, 0x3a5f, 0x393c, 0xba07,
           0x33ec, 0x2853, 0x3bfc, 0x3541, 0x332a, 0xb748, 0x395b, 0xbad7);
  asm volatile("vfnmacc.vv v2, v4, v6, v0.t");
  //               0.0000, -0.2517,  0.0000,  0.0863,  0.0000, -0.7246,  0.0000,
  //               0.2788,  0.0000, -0.7271,  0.0000, -0.4583,  0.0000,  0.4795,
  //               0.0000,  0.7153
  VCMP_U16(3, v2, 0x39ec, 0xb407, 0x30a8, 0x2d86, 0x355b, 0xb9cc, 0x393c,
           0x3476, 0x33ec, 0xb9d1, 0x3bfc, 0xb755, 0x332a, 0x37ac, 0x395b,
           0x39b9);

  VSET(16, e32, m2);
  //              -0.17374928, -0.36242354, -0.18093164,  0.94970566,
  //              -0.45790458, -0.17780401, -0.51985794, -0.04832974,
  //              0.13252106,  0.77533042,  0.42536697, -0.72199643,
  //              -0.25088808,  0.28798762,  0.66300607, -0.63549894
  VLOAD_32(v4, 0xbe31eb55, 0xbeb98f94, 0xbe394625, 0x3f731fe9, 0xbeea7278,
           0xbe361241, 0xbf051569, 0xbd45f569, 0x3e07b39a, 0x3f467c0e,
           0x3ed9c9b3, 0xbf38d4c2, 0xbe807467, 0x3e93731d, 0x3f29bac4,
           0xbf22b00f);
  //              -0.61242568,  0.71439523, -0.15632962,  0.10917858,
  //              0.19637996, -0.88467985,  0.73412597, -0.98048240, 0.25438991,
  //              -0.02058743, -0.00876777,  0.21936898, -0.71130067,
  //              -0.29675287, -0.96093589,  0.24695934
  VLOAD_32(v6, 0xbf1cc7ee, 0x3f36e29b, 0xbe2014df, 0x3ddf9905, 0x3e4917d4,
           0xbf627a61, 0x3f3befae, 0xbf7b00e5, 0x3e823f65, 0xbca8a6f9,
           0xbc0fa6af, 0x3e60a243, 0xbf3617cd, 0xbe97effe, 0xbf75ffe5,
           0x3e7ce2e9);
  VLOAD_8(v0, 0xAA, 0xAA);
  //               0.77600455,  0.02542816, -0.63618338,  0.11704731,
  //               0.45613721, -0.90825689,  0.21235447,  0.35766414,
  //               0.08650716, -0.98431164,  0.21029140, -0.92919809,
  //               0.46440944,  0.70648551, -0.80876821, -0.19595607
  VLOAD_32(v2, 0x3f46a83c, 0x3cd04eb8, 0xbf22dcea, 0x3defb680, 0x3ee98ad1,
           0xbf688386, 0x3e597373, 0x3eb71fc1, 0x3db12aaa, 0xbf7bfbd9,
           0x3e5756a1, 0xbf6ddfed, 0x3eedc713, 0x3f34dc3c, 0xbf4f0b6f,
           0xbe48a8b5);
  asm volatile("vfnmacc.vv v2, v4, v6, v0.t");
  //               0.00000000,  0.23348548,  0.00000000, -0.22073483,
  //               0.00000000,  0.75095725,  0.00000000, -0.40505061,
  //               0.00000000,  1.00027370,  0.00000000,  1.08758175,
  //               0.00000000, -0.62102437,  0.00000000,  0.35289848
  VCMP_U32(4, v2, 0x3f46a83c, 0x3e6f16d2, 0xbf22dcea, 0xbe62084f, 0x3ee98ad1,
           0x3f403ebc, 0x3e597373, 0xbecf62cb, 0x3db12aaa, 0x3f8008f8,
           0x3e5756a1, 0x3f8b35e1, 0x3eedc713, 0xbf1efb74, 0xbf4f0b6f,
           0x3eb4af1c);
};

// Simple random test with similar values (vector-scalar)
void TEST_CASE3(void) {
  VSET(16, e16, m2);
  float fscalar_16;
  //                              0.1300
  BOX_HALF_IN_FLOAT(fscalar_16, 0x3029);
  //              -0.2844,  0.4070, -0.1837, -0.2321, -0.5283, -0.6104, -0.7183,
  //              -0.1191,  0.7998,  0.1169,  0.1169, -0.9214, -0.4360, -0.6250,
  //              -0.5386,  0.6543
  VLOAD_16(v4, 0xb48d, 0x3683, 0xb1e1, 0xb36d, 0xb83a, 0xb8e2, 0xb9bf, 0xaf9f,
           0x3a66, 0x2f7c, 0x2f7c, 0xbb5f, 0xb6fa, 0xb900, 0xb84f, 0x393c);
  //               0.9268, -0.3337, -0.3225, -0.8306, -0.1857, -0.6831,  0.0557,
  //               0.5586,  0.2352,  0.6294,  0.6294, -0.8877, -0.2426,  0.5488,
  //               0.4001,  0.1772
  VLOAD_16(v2, 0x3b6a, 0xb557, 0xb529, 0xbaa5, 0xb1f1, 0xb977, 0x2b21, 0x3878,
           0x3387, 0x3909, 0x3909, 0xbb1a, 0xb3c3, 0x3864, 0x3667, 0x31ac);
  asm volatile("vfnmacc.vf v2, %[A], v4" ::[A] "f"(fscalar_16));
  //              -0.8896,  0.2808,  0.3464,  0.8608,  0.2544,  0.7627,  0.0377,
  //              -0.5430, -0.3394, -0.6445, -0.6445,  1.0078,  0.2993, -0.4675,
  //              -0.3301, -0.2622
  VCMP_U16(5, v2, 0xbb1e, 0x347e, 0x358b, 0x3ae3, 0x3412, 0x3a1a, 0x28d3,
           0xb858, 0xb56d, 0xb928, 0xb928, 0x3c08, 0x34ca, 0xb77b, 0xb548,
           0xb432);

  VSET(16, e32, m2);
  float fscalar_32;
  //                              -0.26917368
  BOX_FLOAT_IN_FLOAT(fscalar_32, 0xbe89d122);
  //              -0.27745819, -0.86308837, -0.16746511, -0.68674469,
  //              -0.49064314, -0.74352056, -0.17169137,  0.26071417,
  //              0.71857828,  0.07920383, -0.43244356, -0.58339220, 0.80679923,
  //              0.23900302,  0.73513943, -0.80685192
  VLOAD_32(v4, 0xbe8e0f00, 0xbf5cf35c, 0xbe2b7bf9, 0xbf2fce80, 0xbefb3594,
           0xbf3e575d, 0xbe2fcfdd, 0x3e857c54, 0x3f37f4bf, 0x3da2359e,
           0xbedd693e, 0xbf155931, 0x3f4e8a65, 0x3e74bd35, 0x3f3c3219,
           0xbf4e8dd9);
  //               0.13509545, -0.29169917,  0.80494332, -0.63637137,
  //               0.63772237, -0.87242430, -0.44194883, -0.41286576,
  //               -0.57735479,  0.61664599,  0.94073379, -0.89744234,
  //               -0.70681161,  0.23247144,  0.06774496, -0.38581881
  VLOAD_32(v2, 0x3e0a5676, 0xbe955998, 0x3f4e10c4, 0xbf22e93c, 0x3f2341c6,
           0xbf5f5733, 0xbee2471e, 0xbed36324, 0xbf13cd86, 0x3f1ddc83,
           0x3f70d3ee, 0xbf65bec8, 0xbf34f19b, 0x3e6e0cfe, 0x3d8abdde,
           0xbec58a0b);
  asm volatile("vfnmacc.vf v2, %[A], v4" ::[A] "f"(fscalar_32));
  //              -0.20977989,  0.05937849, -0.85002053,  0.45151776,
  //              -0.76979059,  0.67228812,  0.39573404,  0.48304313,
  //              0.77077717, -0.59532642, -1.05713618,  0.74040854, 0.92398071,
  //              -0.16813812,  0.13013524,  0.16863550
  VCMP_U32(6, v2, 0xbe56d08a, 0x3d7336de, 0xbf599af2, 0x3ee72d57, 0xbf4510ff,
           0x3f2c1b13, 0x3eca9da7, 0x3ef7516f, 0x3f4551a7, 0xbf186750,
           0xbf87503d, 0x3f3d8b6a, 0x3f6c8a00, 0xbe2c2c66, 0x3e05422c,
           0x3e2caec9);
};

// Simple random test with similar values (vector-scalar) (masked)
void TEST_CASE4(void) {
  VSET(16, e16, m2);
  float fscalar_16;
  //                              0.1300
  BOX_HALF_IN_FLOAT(fscalar_16, 0x3029);
  //               -0.2844,  0.4070, -0.1837, -0.2321, -0.5283, -0.6104,
  //               -0.7183, -0.1191,  0.7998,  0.1169,  0.2551, -0.9214,
  //               -0.4360, -0.6250, -0.5386,  0.6543
  VLOAD_16(v4, 0xb48d, 0x3683, 0xb1e1, 0xb36d, 0xb83a, 0xb8e2, 0xb9bf, 0xaf9f,
           0x3a66, 0x2f7c, 0x3415, 0xbb5f, 0xb6fa, 0xb900, 0xb84f, 0x393c);
  VLOAD_8(v0, 0xAA, 0xAA);
  //                0.9268, -0.3337, -0.3225, -0.8306, -0.1857, -0.6831, 0.0557,
  //                0.5586,  0.2352,  0.6294, -0.0325, -0.8877, -0.2426, 0.5488,
  //                0.4001,  0.1772
  VLOAD_16(v2, 0x3b6a, 0xb557, 0xb529, 0xbaa5, 0xb1f1, 0xb977, 0x2b21, 0x3878,
           0x3387, 0x3909, 0xa828, 0xbb1a, 0xb3c3, 0x3864, 0x3667, 0x31ac);
  asm volatile("vfnmacc.vf v2, %[A], v4, v0.t" ::[A] "f"(fscalar_16));
  //                0.0000,  0.2808,  0.0000,  0.8608,  0.0000,  0.7627, 0.0000,
  //                -0.5430,  0.0000, -0.6445,  0.0000,  1.0078,  0.0000,
  //                -0.4675,  0.0000, -0.2622
  VCMP_U16(7, v2, 0x3b6a, 0x347e, 0xb529, 0x3ae3, 0xb1f1, 0x3a1a, 0x2b21,
           0xb858, 0x3387, 0xb928, 0xa828, 0x3c08, 0xb3c3, 0xb77b, 0x3667,
           0xb432);

  VSET(16, e32, m2);
  float fscalar_32;
  //                              -0.26917368
  BOX_FLOAT_IN_FLOAT(fscalar_32, 0xbe89d122);
  //               -0.27745819, -0.86308837, -0.16746511, -0.68674469,
  //               -0.49064314, -0.74352056, -0.17169137,  0.26071417,
  //               0.71857828,  0.07920383, -0.43244356, -0.58339220,
  //               0.80679923,  0.23900302,  0.73513943, -0.80685192
  VLOAD_32(v4, 0xbe8e0f00, 0xbf5cf35c, 0xbe2b7bf9, 0xbf2fce80, 0xbefb3594,
           0xbf3e575d, 0xbe2fcfdd, 0x3e857c54, 0x3f37f4bf, 0x3da2359e,
           0xbedd693e, 0xbf155931, 0x3f4e8a65, 0x3e74bd35, 0x3f3c3219,
           0xbf4e8dd9);
  VLOAD_8(v0, 0xAA, 0xAA);
  //                0.13509545, -0.29169917,  0.80494332, -0.63637137,
  //                0.63772237, -0.87242430, -0.44194883, -0.41286576,
  //                -0.57735479,  0.61664599,  0.94073379, -0.89744234,
  //                -0.70681161,  0.23247144,  0.06774496, -0.38581881
  VLOAD_32(v2, 0x3e0a5676, 0xbe955998, 0x3f4e10c4, 0xbf22e93c, 0x3f2341c6,
           0xbf5f5733, 0xbee2471e, 0xbed36324, 0xbf13cd86, 0x3f1ddc83,
           0x3f70d3ee, 0xbf65bec8, 0xbf34f19b, 0x3e6e0cfe, 0x3d8abdde,
           0xbec58a0b);
  asm volatile("vfnmacc.vf v2, %[A], v4, v0.t" ::[A] "f"(fscalar_32));
  //                0.00000000,  0.05937849,  0.00000000,  0.45151776,
  //                0.00000000,  0.67228812,  0.00000000,  0.48304313,
  //                0.00000000, -0.59532642,  0.00000000,  0.74040854,
  //                0.00000000, -0.16813812,  0.00000000,  0.16863550
  VCMP_U32(8, v2, 0x3e0a5676, 0x3d7336de, 0x3f4e10c4, 0x3ee72d57, 0x3f2341c6,
           0x3f2c1b13, 0xbee2471e, 0x3ef7516f, 0xbf13cd86, 0xbf186750,
           0x3f70d3ee, 0x3f3d8b6a, 0xbf34f19b, 0xbe2c2c66, 0x3d8abdde,
           0x3e2caec9);
};

int main(void) {
  INIT_CHECK();
  enable_vec();
  enable_fp();

  TEST_CASE1();
  //TEST_CASE2();
  TEST_CASE3();
  //TEST_CASE4();

  EXIT_CHECK();
}
